---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import type { CollectionEntry } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import PostCard from '../../../components/blog/PostCard.astro';
import Pagination from '../../../components/layout/Pagination.astro';
import { SITE_TITLE } from '../../../consts';
import { getHeroColors, gradientStylesToString, getGradientStyles } from '../../../utils/hero-colors';

export const getStaticPaths = (async ({ paginate }) => {
	const allPosts = await getCollection('blog');
	const allTunes = await getCollection('tunes');
	const allContent = [...allPosts, ...allTunes];

	// Get unique years
	const years = [...new Set(allContent.map(item =>
		item.data.pubDate.getFullYear().toString()
	))];

	// Create paginated paths for each year
	const paths = [];
	for (const year of years) {
		const yearContent = allContent
			.filter(item => (import.meta.env.DEV || !item.data.draft) && item.data.pubDate.getFullYear().toString() === year)
			.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

		const paginatedPaths = paginate(yearContent, {
			params: { year },
			pageSize: 10,
		});

		paths.push(...paginatedPaths);
	}

	return paths;
}) satisfies GetStaticPaths;

const { page } = Astro.props;
const { year } = Astro.params;

const title = `${year} Archive - Page ${page.currentPage} - ${SITE_TITLE}`;
const description = `All posts and tunes from ${year} - Page ${page.currentPage}`;

// Get gradient colors from first post's hero image
const firstPost = page.data[0];
const firstPostHeroImage = firstPost?.data.heroImage || firstPost?.data.cover?.image;
const heroColors = getHeroColors(firstPostHeroImage);
const gradientStyleString = gradientStylesToString(getGradientStyles(heroColors));
---

<BaseLayout title={title} description={description}>
	<!-- Hero gradient background from first post -->
	<section
		class="hero-gradient-section absolute inset-x-0 top-0 -z-10 h-[70vh] min-h-[450px]"
		style={gradientStyleString}
	>
		<div class="hero-gradient-bg absolute inset-0"></div>
	</section>
	<section class="max-w-3xl mx-auto px-5">
		<h1 class="text-4xl font-bold mb-8 text-gray-900 dark:text-gray-100">{year}</h1>
		<p class="text-gray-600 dark:text-gray-400 mb-8">
			{page.total} {page.total === 1 ? 'post' : 'posts'} published in {year}
		</p>

		<ul class="space-y-12">
			{page.data.map((item: CollectionEntry<'blog'> | CollectionEntry<'tunes'>, index: number) => (
				<li>
					<PostCard post={item} priority={index === 0 && page.currentPage === 1} />
				</li>
			))}
		</ul>

		{page.total > page.size && (
			<Pagination
				currentPage={page.currentPage}
				totalPages={page.lastPage}
				getHref={(pageNum) => (pageNum === 1 ? `/${year}/` : `/${year}/page/${pageNum}/`)}
			/>
		)}
	</section>
</BaseLayout>
