---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import PostCard from '../../../components/blog/PostCard.astro';
import Pagination from '../../../components/layout/Pagination.astro';
import { getHeroColors, gradientStylesToString, getGradientStyles } from '../../../utils/hero-colors';

export const getStaticPaths = (async () => {
	// 9 posts per page fills 3 rows nicely in the grid
	const postsPerPage = 9;
	// First page shows 7 (1 featured + 6 grid)
	const firstPagePosts = 7;

	const allTunes = (await getCollection('tunes'))
		.filter(tune => !tune.data.draft)
		.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

	// Calculate total pages accounting for different first page size
	const remainingPosts = allTunes.length - firstPagePosts;
	const totalPages = 1 + Math.ceil(Math.max(0, remainingPosts) / postsPerPage);

	// Generate paths for pages 2 and onwards (page 1 is handled by /tunes/index.astro)
	return Array.from({ length: Math.max(0, totalPages - 1) }, (_, i) => {
		const pageNum = i + 2;
		const start = firstPagePosts + (pageNum - 2) * postsPerPage;
		const end = start + postsPerPage;

		return {
			params: { page: pageNum.toString() },
			props: {
				tunes: allTunes.slice(start, end),
				currentPage: pageNum,
				totalPages
			}
		};
	});
}) satisfies GetStaticPaths;

const { tunes, currentPage, totalPages } = Astro.props;

// Get gradient colors from first tunes post's hero image
const firstPost = tunes[0];
const firstPostHeroImage = firstPost?.data.heroImage || firstPost?.data.cover?.image;
const heroColors = getHeroColors(firstPostHeroImage);
const gradientStyleString = gradientStylesToString(getGradientStyles(heroColors));
---

<BaseLayout title={`Listened to This Week - Page ${currentPage}`} description="My weekly music listening posts - what I've been enjoying on repeat">
	<!-- Hero gradient background from first post -->
	<section
		class="hero-gradient-section absolute inset-x-0 top-0 -z-10 h-[70vh] min-h-[450px]"
		style={gradientStyleString}
	>
		<div class="hero-gradient-bg absolute inset-0"></div>
	</section>

	<section class="max-w-6xl mx-auto px-5">
		<h1 class="sr-only">Listened to This Week - Page {currentPage}</h1>

		{/* 3-column grid of tunes */}
		<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8 items-stretch">
			{tunes.map((tune) => (
				<PostCard post={tune} variant="grid" headingLevel="2" />
			))}
		</div>

		{totalPages > 1 && (
			<Pagination
				currentPage={currentPage}
				totalPages={totalPages}
				getHref={(pageNum) => (pageNum === 1 ? '/tunes/' : `/tunes/page/${pageNum}/`)}
				hideIfSingle={false}
			/>
		)}
	</section>
</BaseLayout>
