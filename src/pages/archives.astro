---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { SITE_TITLE } from '../consts';

// Get all posts and tunes
const allPosts = await getCollection('blog');
const allTunes = await getCollection('tunes');
const allContent = [...allPosts, ...allTunes];

// Filter out drafts in production
const publishedContent = allContent.filter(item =>
	import.meta.env.DEV || !item.data.draft
);

// Get unique years with post counts
const yearStats = publishedContent.reduce((acc, item) => {
	const year = item.data.pubDate.getFullYear().toString();
	acc[year] = (acc[year] || 0) + 1;
	return acc;
}, {} as Record<string, number>);

// Sort years in descending order
const years = Object.keys(yearStats).sort((a, b) => parseInt(b) - parseInt(a));

const title = `Archives - ${SITE_TITLE}`;
const description = 'Browse all posts by year';
---

<BaseLayout title={title} description={description}>
	<section class="max-w-3xl mx-auto px-5">
		<h1 class="text-4xl font-bold mb-4 text-gray-900 dark:text-gray-100">Archives</h1>
		<p class="text-gray-600 dark:text-gray-400 mb-8">
			Browse all {publishedContent.length} posts organized by year
		</p>

		<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
			{years.map(year => (
				<a
					href={`/${year}/`}
					class="group block p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-lg hover:border-blue-500 dark:hover:border-blue-500 transition-colors"
				>
					<div class="text-2xl font-bold text-gray-900 dark:text-gray-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
						{year}
					</div>
					<div class="text-sm text-gray-600 dark:text-gray-400 mt-2">
						{yearStats[year]} {yearStats[year] === 1 ? 'post' : 'posts'}
					</div>
				</a>
			))}
		</div>
	</section>
</BaseLayout>
