---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import PostCard from '../components/blog/PostCard.astro';
import HeroSection from '../components/home/HeroSection.astro';
import Pagination from '../components/layout/Pagination.astro';
import { SITE_TITLE, SITE_DESCRIPTION, CF_IMAGE_PRESETS } from '../consts';
import { getHeroColors, gradientStylesToString, getGradientStyles } from '../utils/hero-colors';
import { generateCFSrcSet } from '../utils/cloudflare-images';

// Homepage shows 1 featured + 6 grid cards = 7 total
const postsPerPage = 7;
// Pagination pages use 9 posts per page - must match [...page].astro pageSize
const paginationPageSize = 9;

const allPosts = (await getCollection('blog'))
	.filter(post => import.meta.env.DEV || !post.data.draft)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const posts = allPosts.slice(0, postsPerPage);
const totalPages = Math.ceil(allPosts.length / paginationPageSize);

// Split posts: first for hero, rest for grid
const featuredPost = posts[0];
const gridPosts = posts.slice(1);

// Get first post hero image for LCP preload optimization
// Use Cloudflare image transformation to match what PostCard uses
const firstPostHeroImage = featuredPost?.data.heroImage || featuredPost?.data.cover?.image;
const preloadSrcSet = firstPostHeroImage ? generateCFSrcSet(
	firstPostHeroImage,
	CF_IMAGE_PRESETS.thumbnailPriority.widths,
	CF_IMAGE_PRESETS.thumbnailPriority.quality,
	CF_IMAGE_PRESETS.thumbnailPriority.format
) : null;

// Get gradient colors from first post's hero image
const heroColors = getHeroColors(firstPostHeroImage);
const gradientStyleString = gradientStylesToString(getGradientStyles(heroColors));
---

<BaseLayout title={SITE_TITLE} description={SITE_DESCRIPTION}>
	{preloadSrcSet && (
		<link
			slot="head"
			rel="preload"
			as="image"
			imagesrcset={preloadSrcSet}
			imagesizes="(min-width: 1024px) 50vw, 100vw"
			fetchpriority="high"
		/>
	)}
	<!-- Hero gradient background from first post -->
	<section
		class="hero-gradient-section absolute inset-x-0 top-0 -z-10 h-[70vh] min-h-[450px]"
		style={gradientStyleString}
	>
		<div class="hero-gradient-bg absolute inset-0"></div>
	</section>

	<section class="max-w-6xl mx-auto px-5">
		<h1 class="sr-only">{SITE_TITLE}</h1>

		{/* Hero Section with Featured Post */}
		<HeroSection featuredPost={featuredPost} />

		{/* Grid of remaining posts */}
		{gridPosts.length > 0 && (
			<div class="mt-8 sm:mt-10">
				<h2 class="sr-only">More Posts</h2>
				<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8 items-stretch">
					{gridPosts.map((post) => (
						<PostCard post={post} variant="grid" headingLevel="3" />
					))}
				</div>
			</div>
		)}

		<Pagination
			currentPage={1}
			totalPages={totalPages}
			getHref={(pageNum) => (pageNum === 1 ? '/' : `/page/${pageNum}/`)}
		/>
	</section>
</BaseLayout>
