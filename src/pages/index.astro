---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import PostCard from '../components/blog/PostCard.astro';
import Pagination from '../components/layout/Pagination.astro';
import { SITE_TITLE, SITE_DESCRIPTION, CF_IMAGE_PRESETS } from '../consts';
import { getHeroColors, gradientStylesToString, getGradientStyles } from '../utils/hero-colors';
import { getCFImageUrl } from '../utils/cloudflare-images';
const postsPerPage = 5;

const allPosts = (await getCollection('blog'))
	.filter(post => import.meta.env.DEV || !post.data.draft)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const posts = allPosts.slice(0, postsPerPage);
const totalPages = Math.ceil(allPosts.length / postsPerPage);

// Get first post hero image for LCP preload optimization
// Use Cloudflare image transformation to match what PostCard uses
const firstPost = posts[0];
const firstPostHeroImage = firstPost?.data.heroImage || firstPost?.data.cover?.image;
const preloadImageUrl = firstPostHeroImage ? getCFImageUrl(firstPostHeroImage, {
	width: CF_IMAGE_PRESETS.thumbnailPriority.widths[CF_IMAGE_PRESETS.thumbnailPriority.widths.length - 1],
	quality: CF_IMAGE_PRESETS.thumbnailPriority.quality,
	format: CF_IMAGE_PRESETS.thumbnailPriority.format,
	fit: CF_IMAGE_PRESETS.thumbnailPriority.fit
}) : null;

// Get gradient colors from first post's hero image
const heroColors = getHeroColors(firstPostHeroImage);
const gradientStyleString = gradientStylesToString(getGradientStyles(heroColors));
---

<BaseLayout title={SITE_TITLE} description={SITE_DESCRIPTION}>
	{preloadImageUrl && (
		<link
			slot="head"
			rel="preload"
			as="image"
			href={preloadImageUrl}
			type="image/avif"
			fetchpriority="high"
		/>
	)}
	<!-- Hero gradient background from first post -->
	<section
		class="hero-gradient-section absolute inset-x-0 top-0 -z-10 h-[70vh] min-h-[450px]"
		style={gradientStyleString}
	>
		<div class="hero-gradient-bg absolute inset-0"></div>
	</section>
	<section class="max-w-3xl mx-auto px-5">
		<h1 class="sr-only">{SITE_TITLE}</h1>
		<ul class="space-y-12">
			{posts.map((post, index) => (
				<li>
					<PostCard post={post} priority={index === 0} />
				</li>
			))}
		</ul>

			<Pagination
				currentPage={1}
				totalPages={totalPages}
				getHref={(pageNum) => (pageNum === 1 ? '/' : `/page/${pageNum}/`)}
			/>
		</section>
</BaseLayout>
