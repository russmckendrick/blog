---
import type { CollectionEntry } from 'astro:content';
import FormattedDate from './FormattedDate.astro';
import { getPostUrl } from '../../utils/url.ts';
import { calculateReadingTime, formatReadingTime } from '../../utils/reading-time';
import { getTagUrl, getTagDisplayName, getTagColorClasses, normalizeTagSlug } from '../../utils/tags';
import { getCFImageUrl, generateCFSrcSet, getLQIPUrl } from '../../utils/cloudflare-images';
import { AI_AUTHOR, TAG_METADATA, TAG_AVATAR_MAP, CF_IMAGE_PRESETS } from '../../consts';

interface Props {
	post: CollectionEntry<'blog'> | CollectionEntry<'tunes'>;
	priority?: boolean; // For LCP optimization on first card
	variant?: 'vertical' | 'horizontal' | 'featured' | 'grid'; // Layout variant
	headingLevel?: '2' | '3'; // Heading level for accessibility
}

const { post, priority = false, variant = 'vertical', headingLevel = '2' } = Astro.props;
const HeadingTag = `h${headingLevel}` as 'h2' | 'h3';
const href = getPostUrl(post.data.pubDate, post.data.title);
const heroImage = post.data.heroImage || post.data.cover?.image;
const alt = post.data.cover?.alt || post.data.title;
const description = post.data.summary || post.data.description;
const minutes = calculateReadingTime(post.body);
const readingTime = formatReadingTime(minutes);
const author = post.data.author || AI_AUTHOR.name;
const tags = post.data.tags ?? [];

// Check if this is an AI-generated post
const isAIAuthor = author === AI_AUTHOR.name;

// Build avatar path
const buildAvatarPath = (avatarName: string | undefined) => {
	if (!avatarName) return null;
	if (avatarName.includes('.')) {
		return `/images/avatars/${avatarName}`;
	}
	return `/images/avatars/${avatarName}.svg`;
};

// Get avatar from primary tag if no avatar specified
const getDefaultAvatar = () => {
	if (isAIAuthor) return AI_AUTHOR.avatar;
	const primaryTag = tags[0];
	if (primaryTag && TAG_AVATAR_MAP[normalizeTagSlug(primaryTag)]) {
		return `/images/avatars/${TAG_AVATAR_MAP[normalizeTagSlug(primaryTag)]}`;
	}
	return '/images/avatar.svg';
};

// Determine avatar source
const avatarSrc = post.data.avatar
	? buildAvatarPath(post.data.avatar)
	: getDefaultAvatar();
const avatarFallback = '/images/avatar-192x192.png';

// Get the primary tag color for avatar glow
const primaryTag = tags[0];
const getAvatarGlowColor = () => {
	if (!primaryTag || !TAG_METADATA[primaryTag]) {
		return 'text-blue-600 dark:text-blue-400';
	}

	const tagColorLight = TAG_METADATA[primaryTag].colorLight;

	// Extract the text color class from tag metadata (e.g., "text-purple-700")
	const textColorMatch = tagColorLight.match(/text-(\w+)-(\d+)/);
	if (textColorMatch) {
		const [, color, shade] = textColorMatch;
		return `text-${color}-${shade} dark:text-${color}-400`;
	}

	return 'text-blue-600 dark:text-blue-400';
};

const avatarGlowColor = getAvatarGlowColor();

// Generate LQIP placeholder URL for blur-up effect
const lqipUrl = heroImage ? getLQIPUrl(heroImage) : null;
---

{variant === 'vertical' ? (
	<a
		href={href}
		aria-label={`Read blog post: ${post.data.title}`}
		class="group block focus:outline-none focus-visible:ring-4 focus-visible:ring-blue-500/60 focus-visible:ring-offset-[16px] focus-visible:ring-offset-gray-100 dark:focus-visible:ring-offset-gray-900 rounded-[28px]">
		<article
			class={`relative bg-white/95 dark:bg-gray-900/70 border border-gray-200/60 dark:border-gray-700 rounded-[28px] shadow-lg dark:shadow-black/30 overflow-hidden ${priority ? '' : 'transition-all duration-500 group-hover:-translate-y-[3px] group-hover:shadow-2xl'}`}>
				{heroImage && (
					<figure
						class="relative overflow-hidden bg-cover bg-center bg-no-repeat"
						style={lqipUrl ? `background-image: url('${lqipUrl}')` : undefined}
					>
						{/* LQIP blur overlay - shows while main image loads */}
						{lqipUrl && (
							<div
								class="absolute inset-0 bg-cover bg-center bg-no-repeat blur-lg scale-105 -z-10"
								style={`background-image: url('${lqipUrl}')`}
								aria-hidden="true"
							/>
						)}
						<img
							src={getCFImageUrl(heroImage, {
								width: priority ? 400 : 600,
								quality: priority ? CF_IMAGE_PRESETS.thumbnailPriority.quality : CF_IMAGE_PRESETS.thumbnail.quality,
								format: priority ? CF_IMAGE_PRESETS.thumbnailPriority.format : CF_IMAGE_PRESETS.thumbnail.format,
								fit: priority ? CF_IMAGE_PRESETS.thumbnailPriority.fit : CF_IMAGE_PRESETS.thumbnail.fit
							})}
							srcset={generateCFSrcSet(
								heroImage,
								priority ? CF_IMAGE_PRESETS.thumbnailPriority.widths : CF_IMAGE_PRESETS.thumbnail.widths,
								priority ? CF_IMAGE_PRESETS.thumbnailPriority.quality : CF_IMAGE_PRESETS.thumbnail.quality,
								priority ? CF_IMAGE_PRESETS.thumbnailPriority.format : CF_IMAGE_PRESETS.thumbnail.format
							)}
							sizes="(min-width: 768px) 720px, calc(100vw - 40px)"
							alt={alt}
							width="1600"
							height="900"
							loading={priority ? "eager" : "lazy"}
							decoding={priority ? "sync" : "async"}
							fetchpriority={priority ? "high" : "low"}
							class={`w-full aspect-[16/9] sm:aspect-[5/2] min-h-[220px] object-cover ${priority ? '' : 'transition-transform duration-700 group-hover:scale-[1.03]'}`}
						/>
					</figure>
				)}
			<div class="relative p-6 md:p-8 flex flex-col gap-6">
				<header class="space-y-3">
					<HeadingTag class="text-2xl font-semibold tracking-tight text-gray-900 dark:text-gray-100">
						{post.data.title}
					</HeadingTag>
				</header>
				{description && (
					<p class="text-base text-gray-700 dark:text-gray-300 leading-relaxed">
						{description}
					</p>
				)}
				<footer class="mt-1 text-sm flex flex-wrap items-center gap-x-2 gap-y-3">
					<div class="flex items-center gap-2">
						<div class="relative flex-shrink-0">
							<div class={`absolute -inset-0.5 bg-gradient-to-r from-current to-current rounded-full opacity-60 blur-sm will-change-transform ${avatarGlowColor}`}></div>
							<img
								src={avatarSrc}
								alt={author}
								class="relative w-10 h-10 sm:w-12 sm:h-12 rounded-full ring-2 ring-white dark:ring-gray-900 shadow-md object-cover"
								onError={`this.onerror=null; this.src='${avatarFallback}';`}
							/>
						</div>
						<div class="flex flex-col">
							<span class="text-gray-700 dark:text-gray-300 font-medium">{author}</span>
							<div class="flex items-center gap-2 text-xs text-gray-700 dark:text-gray-400">
								<span class="text-blue-600 dark:text-blue-400">
									<FormattedDate date={post.data.pubDate} />
								</span>
								{readingTime && (
									<>
										<span aria-hidden="true">路</span>
										<span>{readingTime}</span>
									</>
								)}
							</div>
						</div>
					</div>
					{tags.length > 0 && (
						<div class="flex flex-wrap gap-2 ml-auto">
							{tags.slice(0, 6).map((tag) => (
								<a
									href={getTagUrl(tag)}
									class={`inline-flex items-center rounded-full px-2 py-1 text-xs font-medium ${getTagColorClasses(tag)} transition-all hover:scale-105 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500/50`}
									onclick="event.stopPropagation()"
								>
									{getTagDisplayName(tag)}
								</a>
							))}
						</div>
					)}
				</footer>
			</div>
		</article>
	</a>
) : variant === 'featured' ? (
	/* Featured variant - Side-by-side asymmetric layout for hero section */
	<a
		href={href}
		aria-label={`Read blog post: ${post.data.title}`}
		class="group block focus:outline-none focus-visible:ring-4 focus-visible:ring-blue-500/60 focus-visible:ring-offset-[16px] focus-visible:ring-offset-gray-100 dark:focus-visible:ring-offset-gray-900 rounded-3xl">
		<article
			class="relative bg-white/95 dark:bg-gray-900/70 border border-gray-200/60 dark:border-gray-700 rounded-3xl shadow-xl dark:shadow-black/40 overflow-hidden transition-all duration-500 group-hover:shadow-2xl">
			<div class="flex flex-col lg:flex-row">
				{/* Content side */}
				<div class="relative p-8 lg:p-10 xl:p-12 flex flex-col gap-6 lg:w-1/2 order-2 lg:order-1">
					<header class="space-y-4">
						<HeadingTag class="text-3xl lg:text-4xl font-bold tracking-tight text-gray-900 dark:text-gray-100 leading-tight">
							{post.data.title}
						</HeadingTag>
					</header>
					{description && (
						<p class="text-lg text-gray-600 dark:text-gray-300 leading-relaxed">
							{description}
						</p>
					)}
					<footer class="mt-auto pt-4 text-sm flex flex-wrap items-center gap-x-4 gap-y-3">
						<div class="flex items-center gap-3">
							<div class="relative flex-shrink-0">
								<div class={`absolute -inset-0.5 bg-gradient-to-r from-current to-current rounded-full opacity-60 blur-sm will-change-transform ${avatarGlowColor}`}></div>
								<img
									src={avatarSrc}
									alt={author}
									class="relative w-12 h-12 rounded-full ring-2 ring-white dark:ring-gray-900 shadow-md object-cover"
									onError={`this.onerror=null; this.src='${avatarFallback}';`}
								/>
							</div>
							<div class="flex flex-col">
								<span class="text-gray-800 dark:text-gray-200 font-semibold">{author}</span>
								<div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
									<span class="text-blue-600 dark:text-blue-400">
										<FormattedDate date={post.data.pubDate} />
									</span>
									{readingTime && (
										<>
											<span aria-hidden="true">路</span>
											<span>{readingTime}</span>
										</>
									)}
								</div>
							</div>
						</div>
						{tags.length > 0 && (
							<div class="flex flex-wrap gap-2 lg:ml-auto">
								{tags.slice(0, 4).map((tag) => (
									<span
										class={`inline-flex items-center rounded-full px-3 py-1.5 text-sm font-medium ${getTagColorClasses(tag)}`}
									>
										{getTagDisplayName(tag)}
									</span>
								))}
							</div>
						)}
					</footer>
				</div>
				{/* Image side */}
				{heroImage && (
					<figure
						class="relative overflow-hidden lg:w-1/2 order-1 lg:order-2 bg-cover bg-center bg-no-repeat"
						style={lqipUrl ? `background-image: url('${lqipUrl}')` : undefined}
					>
						{lqipUrl && (
							<div
								class="absolute inset-0 bg-cover bg-center bg-no-repeat blur-lg scale-105 -z-10"
								style={`background-image: url('${lqipUrl}')`}
								aria-hidden="true"
							/>
						)}
						<img
							src={getCFImageUrl(heroImage, {
								width: priority ? 600 : 800,
								quality: CF_IMAGE_PRESETS.thumbnailPriority.quality,
								format: CF_IMAGE_PRESETS.thumbnailPriority.format,
								fit: CF_IMAGE_PRESETS.thumbnailPriority.fit
							})}
							srcset={generateCFSrcSet(heroImage, CF_IMAGE_PRESETS.thumbnailPriority.widths, CF_IMAGE_PRESETS.thumbnailPriority.quality, CF_IMAGE_PRESETS.thumbnailPriority.format)}
							sizes="(min-width: 1024px) 50vw, 100vw"
							alt={alt}
							width="1000"
							height="700"
							loading={priority ? "eager" : "lazy"}
							decoding={priority ? "sync" : "async"}
							fetchpriority={priority ? "high" : "low"}
							class="w-full h-64 sm:h-80 lg:h-full lg:min-h-[400px] object-cover transition-transform duration-700 group-hover:scale-[1.02]"
						/>
					</figure>
				)}
			</div>
		</article>
	</a>
) : variant === 'grid' ? (
	/* Grid variant - Compact card for 3-column layouts */
	<a
		href={href}
		aria-label={`Read blog post: ${post.data.title}`}
		class="group block focus:outline-none focus-visible:ring-4 focus-visible:ring-blue-500/60 focus-visible:ring-offset-4 focus-visible:ring-offset-gray-100 dark:focus-visible:ring-offset-gray-900 rounded-2xl h-full">
		<article
			class="relative bg-white/95 dark:bg-gray-900/70 border border-gray-200/60 dark:border-gray-700 rounded-2xl shadow-lg dark:shadow-black/30 overflow-hidden transition-all duration-500 group-hover:-translate-y-1 group-hover:shadow-xl h-full flex flex-col">
			{heroImage && (
				<figure
					class="relative overflow-hidden bg-cover bg-center bg-no-repeat"
					style={lqipUrl ? `background-image: url('${lqipUrl}')` : undefined}
				>
					{lqipUrl && (
						<div
							class="absolute inset-0 bg-cover bg-center bg-no-repeat blur-lg scale-105 -z-10"
							style={`background-image: url('${lqipUrl}')`}
							aria-hidden="true"
						/>
					)}
					<img
						src={getCFImageUrl(heroImage, {
							width: 400,
							quality: CF_IMAGE_PRESETS.thumbnail.quality,
							format: CF_IMAGE_PRESETS.thumbnail.format,
							fit: CF_IMAGE_PRESETS.thumbnail.fit
						})}
						srcset={generateCFSrcSet(heroImage, CF_IMAGE_PRESETS.thumbnail.widths, CF_IMAGE_PRESETS.thumbnail.quality, CF_IMAGE_PRESETS.thumbnail.format)}
						sizes="(min-width: 1024px) 33vw, (min-width: 768px) 50vw, 100vw"
						alt={alt}
						width="500"
						height="375"
						loading="lazy"
						decoding="async"
						fetchpriority="low"
						class="w-full aspect-[4/3] object-cover transition-transform duration-700 group-hover:scale-[1.03]"
					/>
				</figure>
			)}
			<div class="relative p-5 flex flex-col gap-3 flex-1">
				{/* Avatar with glow effect */}
				{heroImage && (
					<div class="absolute -top-5 right-4 z-10">
						<div class="relative flex-shrink-0">
							{/* Glow only on bottom half - clips the top portion */}
							<div class={`absolute -inset-1 rounded-full opacity-60 blur-md will-change-transform ${avatarGlowColor}`} style="background: currentColor; clip-path: inset(40% -50% -50% -50%);"></div>
							<img
								src={avatarSrc}
								alt={author}
								class="relative w-10 h-10 rounded-full ring-2 ring-white dark:ring-gray-900 shadow-md object-cover bg-white dark:bg-gray-800"
								onError={`this.onerror=null; this.src='${avatarFallback}';`}
							/>
						</div>
					</div>
				)}
				{tags.length > 0 && (
					<div class="flex flex-wrap gap-1.5">
						{tags.slice(0, 2).map((tag) => (
							<span
								class={`inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${getTagColorClasses(tag)}`}
							>
								{getTagDisplayName(tag)}
							</span>
						))}
					</div>
				)}
				<header>
					<HeadingTag class="text-base font-semibold tracking-tight text-gray-900 dark:text-gray-100 leading-snug">
						{post.data.title}
					</HeadingTag>
				</header>
				{description && (
					<p class="text-sm text-gray-600 dark:text-gray-400 leading-relaxed line-clamp-2">
						{description}
					</p>
				)}
				<footer class="mt-auto pt-2 text-xs flex items-center gap-2 text-gray-500 dark:text-gray-400">
					<span class="text-blue-600 dark:text-blue-400 font-medium">
						<FormattedDate date={post.data.pubDate} />
					</span>
					{readingTime && (
						<>
							<span aria-hidden="true">路</span>
							<span>{readingTime}</span>
						</>
					)}
				</footer>
			</div>
		</article>
	</a>
) : (
	/* Horizontal variant - Side-by-side for related posts */
	<a
		href={href}
		aria-label={`Read blog post: ${post.data.title}`}
		class="group block focus:outline-none focus-visible:ring-4 focus-visible:ring-blue-500/60 focus-visible:ring-offset-[16px] focus-visible:ring-offset-gray-100 dark:focus-visible:ring-offset-gray-900 rounded-2xl">
		<article
			class="relative bg-white/95 dark:bg-gray-900/70 border border-gray-200/60 dark:border-gray-700 rounded-2xl shadow-lg dark:shadow-black/30 overflow-hidden transition-all duration-500 group-hover:shadow-2xl">
			<div class="flex flex-col sm:flex-row">
				{heroImage && (
					<figure
						class="relative overflow-hidden sm:w-48 md:w-56 lg:w-64 flex-shrink-0 bg-cover bg-center bg-no-repeat"
						style={lqipUrl ? `background-image: url('${lqipUrl}')` : undefined}
					>
						{/* LQIP blur overlay */}
						{lqipUrl && (
							<div
								class="absolute inset-0 bg-cover bg-center bg-no-repeat blur-lg scale-105 -z-10"
								style={`background-image: url('${lqipUrl}')`}
								aria-hidden="true"
							/>
						)}
						<img
							src={getCFImageUrl(heroImage, {
								width: 384,
								quality: CF_IMAGE_PRESETS.thumbnailHorizontal.quality,
								format: CF_IMAGE_PRESETS.thumbnailHorizontal.format,
								fit: CF_IMAGE_PRESETS.thumbnailHorizontal.fit
							})}
							srcset={generateCFSrcSet(heroImage, CF_IMAGE_PRESETS.thumbnailHorizontal.widths, CF_IMAGE_PRESETS.thumbnailHorizontal.quality, CF_IMAGE_PRESETS.thumbnailHorizontal.format)}
							sizes="(min-width: 1024px) 256px, (min-width: 768px) 224px, (min-width: 640px) 192px, 100vw"
							alt={alt}
							width="512"
							height="384"
							loading="lazy"
							fetchpriority="low"
							class="w-full h-48 sm:h-full object-cover transition-transform duration-700 group-hover:scale-[1.03]"
						/>
					</figure>
				)}
				<div class="relative p-6 flex flex-col gap-3 flex-1 min-w-0">
					<header>
						<HeadingTag class="text-xl font-semibold tracking-tight text-gray-900 dark:text-gray-100 line-clamp-2">
							{post.data.title}
						</HeadingTag>
					</header>
					{description && (
						<p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed line-clamp-2">
							{description}
						</p>
					)}
					<footer class="mt-auto text-xs flex items-center gap-2">
						<div class="relative flex-shrink-0">
							<div class={`absolute -inset-0.5 bg-gradient-to-r from-current to-current rounded-full opacity-60 blur-sm will-change-transform ${avatarGlowColor}`}></div>
							<img
								src={avatarSrc}
								alt={author}
								class="relative w-8 h-8 rounded-full ring-2 ring-white dark:ring-gray-900 shadow-md object-cover"
								onError={`this.onerror=null; this.src='${avatarFallback}';`}
							/>
						</div>
						<div class="flex flex-col">
							<span class="text-gray-700 dark:text-gray-300 font-medium text-xs">{author}</span>
							<div class="flex items-center gap-2 text-xs text-gray-700 dark:text-gray-400">
								<span class="text-blue-600 dark:text-blue-400">
									<FormattedDate date={post.data.pubDate} />
								</span>
								{readingTime && (
									<>
										<span aria-hidden="true">路</span>
										<span>{readingTime}</span>
									</>
								)}
							</div>
						</div>
					</footer>
				</div>
			</div>
		</article>
	</a>
)}
