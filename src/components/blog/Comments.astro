---
// Giscus comments component with dark/light mode support
---

<div class="giscus-wrapper mt-12 mb-8">
	<div class="bg-white/95 dark:bg-gray-900/70 border border-gray-200/60 dark:border-gray-700 rounded-2xl shadow-lg shadow-gray-300/50 dark:shadow-black/30 p-6 md:p-8">
		<h2 class="text-2xl font-semibold tracking-tight text-gray-900 dark:text-gray-100 mb-6">Comments</h2>
		<div class="giscus"></div>
		<noscript>
			<p class="text-sm text-gray-500 dark:text-gray-400">Please enable JavaScript to view the comments</p>
		</noscript>
	</div>
</div>

<script>
	let giscusLoaded = false;

	function getGiscusTheme() {
		const htmlElement = document.documentElement;
		const isDark = htmlElement.classList.contains('dark');
		return isDark ? 'dark' : 'light';
	}

	function setGiscusTheme() {
		function sendMessage(message) {
			const iframe = document.querySelector('iframe.giscus-frame');
			if (!iframe) return;
			iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
		}
		sendMessage({
			setConfig: {
				theme: getGiscusTheme(),
			},
		});
	}

	function loadGiscus() {
		if (giscusLoaded) return;
		giscusLoaded = true;

		const attrs = {
			"src": "https://giscus.app/client.js",
			"data-repo": "russmckendrick/blog",
			"data-repo-id": "MDEwOlJlcG9zaXRvcnkzOTYwNTIzNzQ=",
			"data-category": "Comments",
			"data-category-id": "DIC_kwDOF5tHls4CldC4",
			"data-mapping": "pathname",
			"data-strict": "0",
			"data-reactions-enabled": "1",
			"data-emit-metadata": "0",
			"data-input-position": "bottom",
			"data-theme": getGiscusTheme(),
			"data-lang": "en",
			"data-loading": "lazy",
			"crossorigin": "anonymous",
			"async": ""
		};

		const giscusScript = document.createElement("script");
		Object.entries(attrs).forEach(([key, value]) => giscusScript.setAttribute(key, value));

		// Add error handler
		giscusScript.onerror = () => {
			console.warn('Giscus failed to load. Check your configuration at https://giscus.app/');
		};

		const giscusContainer = document.querySelector('.giscus');
		if (giscusContainer) {
			giscusContainer.appendChild(giscusScript);
		}
	}

	// Lazy load Giscus using Intersection Observer
	function setupLazyLoad() {
		const giscusWrapper = document.querySelector('.giscus-wrapper');
		if (!giscusWrapper) return;

		const observer = new IntersectionObserver((entries) => {
			entries.forEach(entry => {
				if (entry.isIntersecting) {
					loadGiscus();
					observer.disconnect();
				}
			});
		}, {
			rootMargin: '200px' // Start loading 200px before it comes into view
		});

		observer.observe(giscusWrapper);
	}

	// Setup lazy loading on page load
	setupLazyLoad();

	// Watch for theme changes
	const themeObserver = new MutationObserver((mutations) => {
		mutations.forEach((mutation) => {
			if (mutation.attributeName === 'class' && giscusLoaded) {
				setGiscusTheme();
			}
		});
	});

	themeObserver.observe(document.documentElement, {
		attributes: true,
		attributeFilter: ['class']
	});

	// Re-setup lazy loading after View Transitions
	document.addEventListener('astro:page-load', () => {
		giscusLoaded = false;
		setupLazyLoad();
	});
</script>