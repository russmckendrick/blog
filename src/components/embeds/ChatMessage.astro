---
interface Props {
	/** Position of the message: "left" or "right" (default: "left") */
	position?: 'left' | 'right';
	/** Avatar image URL (optional) */
	avatar?: string;
	/** Optional name to display above message */
	name?: string;
	/** Optional timestamp */
	time?: string;
	/** Custom color for the bubble (default: "gray" for left, "blue" for right) */
	color?: string;
}

const { position = 'left', avatar, name, time, color } = Astro.props;

// Default colors
const defaultLeftColor = 'bg-gray-200 dark:bg-gray-700';
const defaultRightColor = 'bg-blue-100 dark:bg-blue-900';

// Use custom color or default
const bubbleColor = color || (position === 'left' ? defaultLeftColor : defaultRightColor);
---

<div class={`chat-message flex gap-2.5 my-4 ${position === 'right' ? 'flex-row-reverse' : ''}`}>
	{avatar && (
		<div class="avatar w-10 h-10 rounded-full flex-shrink-0 overflow-hidden flex items-center justify-center self-start">
			<img src={avatar} alt={name || 'Avatar'} class="w-full h-full object-cover" />
		</div>
	)}
	<div class="flex flex-col gap-1 max-w-[70%]">
		{name && (
			<h5 class={`text-xs font-semibold leading-snug ${position === 'right' ? 'text-right' : ''} text-gray-900 dark:text-gray-100`}>
				{name}
			</h5>
		)}
		<div class={`message-bubble relative px-3 py-2 ${bubbleColor} text-gray-900 dark:text-gray-100 ${
			position === 'left'
				? 'rounded-tr-xl rounded-br-xl rounded-bl-xl'
				: 'rounded-tl-xl rounded-bl-xl rounded-br-xl'
		}`}>
			<!-- Triangle tail with flat top -->
			<div class={`chat-tail absolute top-0 ${
				position === 'left' ? 'chat-tail-left -left-1' : 'chat-tail-right -right-1'
			}`}></div>
			<div class="message-text text-xs">
				<slot />
			</div>
		</div>
		{time && (
			<div class={`flex ${position === 'right' ? 'justify-end' : 'justify-start'}`}>
				<h6 class="text-gray-500 dark:text-gray-400 text-[10px] font-normal leading-4">
					{time}
				</h6>
			</div>
		)}
	</div>
</div>

<style is:global>
	/* Chat bubble styling */
	.message-bubble {
		line-height: 1.4;
		word-wrap: break-word;
	}

	/* Triangle tail with flat top pointing outward */
	.chat-tail {
		width: 0;
		height: 0;
		border-style: solid;
	}

	/* Left tail - points to the left */
	.chat-tail-left {
		border-width: 10px 0 0 10px;
		border-color: transparent;
		border-top-color: rgb(229, 231, 235); /* gray-200 */
	}

	.dark .chat-tail-left {
		border-top-color: rgb(55, 65, 81); /* gray-700 */
	}

	/* Right tail - points to the right */
	.chat-tail-right {
		border-width: 10px 10px 0 0;
		border-color: transparent;
		border-top-color: rgb(219, 234, 254); /* blue-100 */
	}

	.dark .chat-tail-right {
		border-top-color: rgb(30, 58, 138); /* blue-900 */
	}

	/* Override prose styles within chat messages */
	.message-text p {
		margin: 0;
	}

	.message-text p:not(:last-child) {
		margin-bottom: 0.5rem;
	}

	.message-text strong {
		font-weight: 600;
	}

	.message-text em {
		font-style: italic;
	}

	.message-text code {
		background-color: rgba(0, 0, 0, 0.1);
		padding: 0.125rem 0.375rem;
		border-radius: 0.25rem;
		font-size: 0.75rem;
		font-family: 'JetBrains Mono', 'Fira Code', monospace;
	}

	.dark .message-text code {
		background-color: rgba(255, 255, 255, 0.1);
	}

	/* Right side messages - code styling */
	.flex-row-reverse .message-text code {
		background-color: rgba(255, 255, 255, 0.2);
	}

	.message-text ul,
	.message-text ol {
		margin: 0.5rem 0;
		margin-left: 1.25rem;
	}

	.message-text li {
		margin: 0.25rem 0;
	}

	.message-text a {
		text-decoration: underline;
		text-underline-offset: 2px;
	}

	.message-text a:hover {
		text-decoration: none;
	}

	/* Left message link colors */
	.chat-message:not(.flex-row-reverse) .message-text a {
		color: #2563eb;
	}

	.dark .chat-message:not(.flex-row-reverse) .message-text a {
		color: #60a5fa;
	}

	/* Right message link colors */
	.chat-message.flex-row-reverse .message-text a {
		color: #2563eb;
		font-weight: 600;
	}

	.dark .chat-message.flex-row-reverse .message-text a {
		color: #60a5fa;
		font-weight: 600;
	}

	.chat-message.flex-row-reverse .message-text a:hover {
		text-decoration: none;
		opacity: 0.8;
	}
</style>