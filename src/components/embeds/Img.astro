---
import { getCFImageUrl, generateCFSrcSet, CF_IMAGE_PRESETS } from '../../utils/cloudflare-images';

interface Props {
  src: string;
  alt?: string;
  width?: string;
  link?: string;
  zoom?: string | boolean;
  sizes?: string;
  fullWidth?: boolean;
}

const { src, alt = '', width, link, zoom = true, sizes, fullWidth = false } = Astro.props;

// Check if src is external URL
const isExternal = src.startsWith('http://') || src.startsWith('https://');

// Determine if zoom should be enabled
const enableZoom = zoom === 'true' || zoom === true;

// For local images, use Cloudflare Image Transformations with gallery preset
const imgSrc = isExternal ? src : getCFImageUrl(src, {
  width: 1200,
  quality: CF_IMAGE_PRESETS.gallery.quality,
  format: CF_IMAGE_PRESETS.gallery.format
});
const highResSrc = isExternal ? src : getCFImageUrl(src, {
  width: 2048,
  quality: CF_IMAGE_PRESETS.gallery.quality,
  format: CF_IMAGE_PRESETS.gallery.format,
  fit: CF_IMAGE_PRESETS.gallery.fit
});
const srcsetString = isExternal ? '' : generateCFSrcSet(
  src,
  CF_IMAGE_PRESETS.gallery.widths,
  CF_IMAGE_PRESETS.gallery.quality,
  CF_IMAGE_PRESETS.gallery.format
);
---

<div class={`img-wrapper mb-1 flex ${fullWidth ? '' : 'justify-center'}`}>
  {enableZoom ? (
    <div class={fullWidth ? 'w-full' : ''}>
      <div 
        class="lightgallery-component" 
        data-options={JSON.stringify({ thumbnail: false, download: false })}
      >
        <a href={highResSrc} data-lg-id="true">
          <img
            src={imgSrc}
            srcset={srcsetString}
            alt={alt}
            loading="lazy"
            decoding="async"
            class={`rounded-lg h-auto hover:opacity-90 transition-opacity cursor-zoom-in ${fullWidth ? 'w-full' : 'max-w-full'}`}
            sizes={sizes || '(min-width: 35em) 1200px, 100vw'}
            {...(width && { width })}
          />
        </a>
      </div>
    </div>
  ) : link ? (
    <a href={link} target="_blank" rel="noopener noreferrer" class={fullWidth ? 'w-full' : ''}>
      <img
        src={imgSrc}
        srcset={srcsetString}
        alt={alt}
        loading="lazy"
        decoding="async"
        class={`rounded-lg h-auto hover:opacity-90 transition-opacity ${fullWidth ? 'w-full' : 'max-w-full'}`}
        sizes={sizes || '(min-width: 35em) 1200px, 100vw'}
        {...(width && { width })}
      />
    </a>
  ) : (
    <img
      src={imgSrc}
      srcset={srcsetString}
      alt={alt}
      loading="lazy"
      decoding="async"
      class={`rounded-lg h-auto ${fullWidth ? 'w-full' : 'max-w-full'}`}
      sizes={sizes || '(min-width: 35em) 1200px, 100vw'}
      {...(width && { width })}
    />
  )}
</div>
