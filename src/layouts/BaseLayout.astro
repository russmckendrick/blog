---
import BaseHead from '../components/layout/BaseHead.astro';
import Header from '../components/layout/Header.astro';
import HeaderWrapper from '../components/layout/HeaderWrapper.astro';
import Footer from '../components/layout/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';

// Import embed components to make them available
import { YouTube } from '@astro-community/astro-embed-youtube';
import { LinkPreview } from '@astro-community/astro-embed-link-preview';

import { WebVitals } from '@casoon/astro-webvitals';

interface Props {
	title?: string;
	description?: string;
	image?: any;
	keywords?: string[];
}

const {
	title = SITE_TITLE,
	description = SITE_DESCRIPTION,
	image,
	keywords
} = Astro.props;

const pageTitle = title === SITE_TITLE ? title : `${title} | ${SITE_TITLE}`;
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={pageTitle} description={description} image={image} keywords={keywords} />
		<slot name="head" />
	</head>
	<body class="bg-gray-50 dark:bg-gray-950">
		<HeaderWrapper autoHide={false}>
			<Header />
		</HeaderWrapper>
		<main class="mt-10 sm:mt-14">
			<slot />
		</main>
		<Footer />
		<WebVitals debug={import.meta.env.DEV} />
		<script>
			// Global cleanup for LightGallery when navigating away from pages
			function cleanupLightGallery() {
				// Remove unified gallery container
				const unifiedGallery = document.getElementById('unified-lightgallery');
				if (unifiedGallery) {
					unifiedGallery.remove();
				}

				// Remove ALL LightGallery elements (comprehensive cleanup)
				const lgSelectors = [
					'.lg-outer',
					'.lg-backdrop',
					'.lg-container',
					'#lg-backdrop',
					'#lg-outer',
					'[class^="lg-"]',
					'[id^="lg-"]'
				];

				lgSelectors.forEach(selector => {
					const elements = document.querySelectorAll(selector);
					elements.forEach(el => el.remove());
				});

				// Also check for any elements directly attached to body that might be LightGallery-related
				const bodyChildren = Array.from(document.body.children);
				bodyChildren.forEach(child => {
					const el = child as HTMLElement;
					if (el.className && typeof el.className === 'string' && el.className.includes('lg-')) {
						el.remove();
					}
				});

				// Reset initialization flags on all galleries
				const galleries = document.querySelectorAll('astro-lightgallery[data-lg-initialized]');
				galleries.forEach(gallery => {
					gallery.removeAttribute('data-lg-initialized');
				});
			}

			// Global cleanup for Mermaid diagrams when navigating away from pages
			function cleanupMermaid() {
				// Remove any Mermaid elements that might have been appended to body
				document.querySelectorAll('[id^="mermaid-"]').forEach(el => {
					// Don't remove elements inside .mermaid-wrapper (those are part of the page content)
					if (!el.closest('.mermaid-wrapper')) {
						el.remove();
					}
				});
			}

			// Cleanup before View Transitions swap
			document.addEventListener('astro:before-swap', () => {
				cleanupLightGallery();
				cleanupMermaid();
			});
		</script>
	</body>
</html>
