name: Generate Weekly Listened to Blog Post

on:
  workflow_dispatch:
  schedule:
    - cron: "00 02 * * 1"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸ‘¨â€ğŸ’» Check out code"
        uses: actions/checkout@v5

      - name: "ğŸŸ¢ Set up Node.js"
        uses: actions/setup-node@v5
        with:
          node-version: '20'
          cache: 'npm'

      - name: "ğŸ¦¾ Install dependencies"
        run: npm ci || (npm install --package-lock-only && npm ci)

      - name: "ğŸƒâ€â™‚ï¸ Run the script to generate blog post"
        env:
          LASTFM_USER: "${{ secrets.LASTFM_USER }}"
          LASTFM_API_KEY: "${{ secrets.LASTFM_API_KEY }}"
          COLLECTION_URL: "${{ secrets.COLLECTION_URL }}"
          OPENAI_API_KEY: "${{ secrets.OPENAI_API_KEY }}"
          TAVILY_API_KEY: "${{ secrets.TAVILY_API_KEY }}"
        run: npm run tunes

      - name: "ğŸ–¼ï¸ Optimize images"
        run: |
          WEEK_FOLDER=$(ls -td public/assets/*-listened-to-this-week 2>/dev/null | head -1)
          if [ -n "$WEEK_FOLDER" ]; then
            echo "Optimizing images in $WEEK_FOLDER"
            npm run optimize "$WEEK_FOLDER"
          else
            echo "No weekly folder found to optimize"
          fi

      - name: "ğŸ“ Generate PR summary"
        id: pr_summary
        run: |
          # Find the generated MDX file (either index.mdx in a directory or direct .mdx file)
          TUNES_POST=$(find src/content/tunes -name "*-listened-to-this-week.mdx" -o -name "index.mdx" -path "*/content/tunes/*-listened-to-this-week/*" | sort -r | head -1)

          if [ -n "$TUNES_POST" ]; then
            echo "Found tunes post: $TUNES_POST"

            # Extract title and description from frontmatter
            TITLE=$(grep "^title:" "$TUNES_POST" | sed 's/^title: *"//' | sed 's/"$//')
            DESCRIPTION=$(grep "^description:" "$TUNES_POST" | sed 's/^description: *"//' | sed 's/"$//')

            # Extract date from filename/directory
            if [[ "$TUNES_POST" == *"/index.mdx" ]]; then
              # It's in a directory structure
              POST_DIR=$(dirname "$TUNES_POST")
              POST_DATE=$(basename "$POST_DIR")
            else
              # It's a direct file, extract date from filename
              POST_FILE=$(basename "$TUNES_POST")
              POST_DATE=$(echo "$POST_FILE" | sed 's/\.mdx$//')
            fi

            echo "Post date: $POST_DATE"

            # Format the date for PR title (e.g., "2025-11-02" -> "Week of Nov 2, 2025")
            YEAR=$(echo "$POST_DATE" | cut -d'-' -f1)
            MONTH=$(echo "$POST_DATE" | cut -d'-' -f2)
            DAY=$(echo "$POST_DATE" | cut -d'-' -f3 | sed 's/-listened-to-this-week//')

            # Convert month number to name
            case $MONTH in
              01) MONTH_NAME="Jan" ;;
              02) MONTH_NAME="Feb" ;;
              03) MONTH_NAME="Mar" ;;
              04) MONTH_NAME="Apr" ;;
              05) MONTH_NAME="May" ;;
              06) MONTH_NAME="Jun" ;;
              07) MONTH_NAME="Jul" ;;
              08) MONTH_NAME="Aug" ;;
              09) MONTH_NAME="Sep" ;;
              10) MONTH_NAME="Oct" ;;
              11) MONTH_NAME="Nov" ;;
              12) MONTH_NAME="Dec" ;;
            esac

            # Remove leading zero from day
            DAY=$(echo $DAY | sed 's/^0//')

            PR_TITLE="ğŸµ Week of ${MONTH_NAME} ${DAY}, ${YEAR}: ${TITLE}"
            echo "PR_TITLE=${PR_TITLE}" >> "$GITHUB_OUTPUT"

            # Count albums and artists
            ALBUM_COUNT=$(find public/assets/${POST_DATE}/albums -name "*.jpg" 2>/dev/null | wc -l | tr -d ' ')
            ARTIST_COUNT=$(find public/assets/${POST_DATE}/artists -name "*.jpg" 2>/dev/null | wc -l | tr -d ' ')

            echo "Found $ALBUM_COUNT albums and $ARTIST_COUNT artists"

            # Extract album sections (## headers, excluding the stats sections)
            ALBUMS=$(grep "^## " "$TUNES_POST" | grep -v "Top Artists" | grep -v "Top Albums" | head -5 | sed 's/^## /- /' | sed 's/ [ğŸµğŸ¤ğŸ¶ğŸ§ğŸŒŒğŸ’¿ğŸ¸ğŸ­ğŸ§˜â€â™‚ï¸].*$//')

            # Build PR body
            cat << 'EOF' > pr_body.md
          ## ğŸµ This Week, I Have Mostly Been Listening To...

          EOF
            echo "**${TITLE}**" >> pr_body.md
            echo "" >> pr_body.md
            echo "${DESCRIPTION}" >> pr_body.md
            echo "" >> pr_body.md
            echo "### ğŸ“Š Stats" >> pr_body.md
            echo "- ğŸ¸ **Artists featured**: ${ARTIST_COUNT}" >> pr_body.md
            echo "- ğŸ’¿ **Albums covered**: ${ALBUM_COUNT}" >> pr_body.md
            echo "- ğŸ“… **Week**: ${POST_DATE}" >> pr_body.md
            echo "" >> pr_body.md
            echo "### ğŸ§ Top Albums This Week" >> pr_body.md
            echo "${ALBUMS}" >> pr_body.md
            echo "" >> pr_body.md
            echo "---" >> pr_body.md
            echo "" >> pr_body.md
            echo "ğŸ¤– *Auto-generated weekly listening post from Last.fm data*" >> pr_body.md

            # Save to output
            {
              echo 'PR_BODY<<EOF'
              cat pr_body.md
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          else
            echo "No tunes post found, using fallback message"
            echo 'PR_TITLE=ğŸ¤– Add weekly listened to blog post' >> "$GITHUB_OUTPUT"
            echo 'PR_BODY=This week, I have mostly been listening to...' >> "$GITHUB_OUTPUT"
          fi

      - name: "ğŸš¨ Create Pull Request"
        uses: peter-evans/create-pull-request@v7
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          commit-message: "${{ steps.pr_summary.outputs.PR_TITLE }}"
          title: "${{ steps.pr_summary.outputs.PR_TITLE }}"
          body: ${{ steps.pr_summary.outputs.PR_BODY }}
          branch: "weekly-listened-to-blog-post"
          branch-suffix: timestamp
