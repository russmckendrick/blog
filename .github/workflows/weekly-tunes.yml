name: Generate Weekly Listened to Blog Post

on:
  workflow_dispatch:
  schedule:
    - cron: "00 02 * * 1"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: "👨‍💻 Check out code"
        uses: actions/checkout@v5

      - name: "🟢 Set up Node.js"
        uses: actions/setup-node@v5
        with:
          package-manager-cache: false

      - name: "🦾 Install dependencies"
        run: npm ci

      - name: "🏃‍♂️ Run the script to generate blog post"
        env:
          LASTFM_USER: "${{ secrets.LASTFM_USER }}"
          LASTFM_API_KEY: "${{ secrets.LASTFM_API_KEY }}"
          COLLECTION_URL: "${{ secrets.COLLECTION_URL }}"
          OPENAI_API_KEY: "${{ secrets.OPENAI_API_KEY }}"
          TAVILY_API_KEY: "${{ secrets.TAVILY_API_KEY }}"
        run: npm run tunes

      - name: "🖼️ Optimize images"
        run: |
          WEEK_FOLDER=$(ls -td public/assets/*-listened-to-this-week 2>/dev/null | head -1)
          if [ -n "$WEEK_FOLDER" ]; then
            echo "Optimizing images in $WEEK_FOLDER"
            npm run optimize "$WEEK_FOLDER"
          else
            echo "No weekly folder found to optimize"
          fi

      - name: "🚨 Create Pull Request"
        uses: peter-evans/create-pull-request@v7
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          commit-message: "🤖 Add weekly listened to blog post"
          title: "🤖 Add weekly listened to blog post"
          body: "This week, I have mostly been listening to..."
          branch: "weekly-listened-to-blog-post"
          branch-suffix: timestamp
