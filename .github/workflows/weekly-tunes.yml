name: Generate Weekly Listened to Blog Post

on:
  workflow_dispatch:
  schedule:
    - cron: "00 02 * * 1"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: "ðŸ‘¨â€ðŸ’» Check out code"
        uses: actions/checkout@v5

      - name: "ðŸŸ¢ Set up Node.js"
        uses: actions/setup-node@v5
        with:
          node-version: '20'
          cache: 'npm'

      - name: "ðŸ¦¾ Install dependencies"
        run: npm ci || (npm install --package-lock-only && npm ci)

      - name: "ðŸƒâ€â™‚ï¸ Run the script to generate blog post"
        env:
          LASTFM_USER: "${{ secrets.LASTFM_USER }}"
          LASTFM_API_KEY: "${{ secrets.LASTFM_API_KEY }}"
          COLLECTION_URL: "${{ secrets.COLLECTION_URL }}"
          OPENAI_API_KEY: "${{ secrets.OPENAI_API_KEY }}"
          TAVILY_API_KEY: "${{ secrets.TAVILY_API_KEY }}"
        run: npm run tunes

      - name: "ðŸ–¼ï¸ Optimize images"
        run: |
          WEEK_FOLDER=$(ls -td public/assets/*-listened-to-this-week 2>/dev/null | head -1)
          if [ -n "$WEEK_FOLDER" ]; then
            echo "Optimizing images in $WEEK_FOLDER"
            npm run optimize "$WEEK_FOLDER"
          else
            echo "No weekly folder found to optimize"
          fi

      - name: "ðŸ“ Generate PR summary"
        id: pr_summary
        run: |
          # Find the generated MDX file
          TUNES_POST=$(find src/content/tunes -name "index.mdx" -type f | sort -r | head -1)

          if [ -n "$TUNES_POST" ]; then
            # Extract title and description from frontmatter
            TITLE=$(grep "^title:" "$TUNES_POST" | sed 's/^title: *"//' | sed 's/"$//')
            DESCRIPTION=$(grep "^description:" "$TUNES_POST" | sed 's/^description: *"//' | sed 's/"$//')

            # Extract date from filename
            POST_DIR=$(dirname "$TUNES_POST")
            POST_DATE=$(basename "$POST_DIR")

            # Count albums and artists
            ALBUM_COUNT=$(find public/assets/${POST_DATE}/albums -name "*.jpg" 2>/dev/null | wc -l | tr -d ' ')
            ARTIST_COUNT=$(find public/assets/${POST_DATE}/artists -name "*.jpg" 2>/dev/null | wc -l | tr -d ' ')

            # Extract top albums from the post (look for ### lines that aren't "Introduction" or section headers)
            TOP_ALBUMS=$(grep "^### " "$TUNES_POST" | grep -v "Introduction" | grep -v "Top Albums" | grep -v "Top Artists" | head -5 | sed 's/^### /- /')

            # Build PR body
            cat << EOF > pr_body.md
          ## ðŸŽµ This Week, I Have Mostly Been Listening To...

          **${TITLE}**

          ${DESCRIPTION}

          ### ðŸ“Š Stats
          - ðŸŽ¸ **Artists featured**: ${ARTIST_COUNT}
          - ðŸ’¿ **Albums covered**: ${ALBUM_COUNT}
          - ðŸ“… **Week**: ${POST_DATE}

          ### ðŸŽ§ Top Albums Preview
          ${TOP_ALBUMS}

          ---

          ðŸ¤– *Auto-generated weekly listening post from Last.fm data*
          EOF

            # Save to output
            {
              echo 'PR_BODY<<EOF'
              cat pr_body.md
              echo EOF
            } >> "$GITHUB_OUTPUT"
          else
            echo 'PR_BODY=This week, I have mostly been listening to...' >> "$GITHUB_OUTPUT"
          fi

      - name: "ðŸš¨ Create Pull Request"
        uses: peter-evans/create-pull-request@v7
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          commit-message: "ðŸ¤– Add weekly listened to blog post"
          title: "ðŸ¤– Add weekly listened to blog post"
          body: ${{ steps.pr_summary.outputs.PR_BODY }}
          branch: "weekly-listened-to-blog-post"
          branch-suffix: timestamp
